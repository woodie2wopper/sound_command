# README_serach_Peak_from_toneset

## コマンド名：serach_Peak_from_toneset.py

date: 2024-11-25

version:0.1

author: Hideki Osaka(toriR. Lab)

## 1. 目的

- 倍音関係にない複数の純音の組み（トーンセット）が同時に再生された10秒の音源を録音したときの、トーンセットの周波数毎に録音からピーク強度とSN比を求める。

## 2. 仕様

- 入力ファイル(input.wav)は10秒程度のwavもしくはmp3データである。

- 録音されている複数の純音（トーンセット）はデフォルトでは{100, 800, 1000, 3400, 4800, 5800, 6400, 7800, 9000, 9400, 9500}Hzである。

- オプション指定(--cut)でWAV音源の頭と尻を削除する。

- 音源をFFT（高速離散フーリエ変換）する。FFT size=2048

- スペクトルの全時間で平均する。

- デフォルトで２KHz-10KHzのピーク周波数毎の強度(dB)とSNR(dB)を求める。

- ピーク周波数はトーンセットの各周波数を中心にデフォルトで±50Hzで最大値を求める。

- グラフを生成（縦軸：周波数、横軸：強度）する。各周波数のピークに赤色で打点する。

- ノイズレベルはトーンセットの周波数帯域でノイズフロアから求める。

- スペクトログラムを出力する。
  - FFT の結果をパワースペクトルに変換するために、np.abs(fft(segment, n=args.fft_size)) ** 2 を使用しました。
  - パワースペクトル密度 (PSD) に変換するために、averaged_spectrum / (sample_rate * args.fft_size) を計算しました。
  - dB への変換は、10 * np.log10(psd + np.finfo(float).eps) を使用しました。
  - この変更により、FFT の強度が plt.specgram() の出力と一致するようになります。

- 入力オプション：
  - 引数なし, --help, -h：help　簡単なコマンド紹介と使い方を表示
  - --cut, -c 数値：先頭と最後を指定数値(秒)削除する
  - --no-img, -n：スペクトログラムの出力なし
  - --toneset, -t トーンセットテキストファイル：トーンセットの入っているテキストファイル
  - --noise-floor, -nf ファイル：トーンセット周波数毎のノイズフロア
  - --low-freq, -l 数値：分析する下限周波数（デフォルト2KHz）
  - --high-freq, -h 数値：分析する上限周波数（デフォルト10KHz）
  - --serch-range, -r 数値：トーンセットの各周波数から±数値の周波数範囲でサーチする。デフォルトは50Hz。
  - --input-audio, -i inputfile.wav：入力音源
  - --max, -mx 数値：ピーク強度の最大値（デフォルトは自動調整）
  - --min, -mn 数値：ピーク強度の最小値（デフォルトは自動調整）
  - --fft-size, -fs 数値：FFTサイズ（デフォルト：2048）
  - --moving-average, -ma 数値：周波数軸の移動平均（デフォルトで０ポイント）
  - --fit-curve, -fc：ノイズフロア推定のためのフィッティング曲線を使用する
  - --remove-signals, -rs：ノイズフロア推定のための信号のピークをフィッティング曲線で除去する
  - --peak-floor, -pf 数値：ピーク削除のためのノイズフロアの範囲（デフォルト：50）
  - --spectrogram, -sp：スペクトログラムの出力
  - --debug, -d：デバッグモード
  - コマンド例）${CMD} -c 1 -l 2000 -h 10000 -t toneset01.txt input.wav

- 出力：
  1. 分析結果：","デリミタの標準出力、内容：ピーク周波数(Hz)、ピーク強度(dB)、SNR(dB)
  2. スペクトル：入力ファイル名+".png"

- エラー処理：

  - 入力ファイルがない場合

  - FFTに失敗した場合

    

- トーンセットファイルの例）

```
    $ cat toneset01.txt
    100
    800
    1000
    3400
    4800
    5800
    6400
    ...
```



- ノイズフロアのファイルの例

```bash
$ cat noisefloor01.txt
100, -70.22
800,-90.3
...
```

