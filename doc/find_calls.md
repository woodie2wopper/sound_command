# `find_calls.py` 仕様書

## 概要
- 音源から地鳴き（短時間の声）を見つける。出力は閾値を超えた時間を出力する。
- アルゴリズムは波形の音声（ノイズを含む）データからピークを見つける。ピークは絶対値ばかりでなく、いくつかの指標（たとえば絶対値の移動平均）を用いて見つける。

## 入力オプション
- `-i`, `--input_file`: 入力ファイル（例：`./123456.mp3`）
- `-o`, `--output_file`: 出力ファイル（例：`./123456_calls.txt`）
- `-th`, `--threshold`: 閾値（デフォルト：最大値の`0.1`）
- `-mf`, `--method` [freq|time|both]: `freq`: 周波数領域でピーク検出方法（デフォルト：`'absolute'`）, `time`: 時間領域でピーク検出方法（デフォルト：`'absolute'`）, `both`: 両方の方法を用いてピーク検出（デフォルト：`'both'`）
- `-D`, `--Duration`: 検出の上限持続時間（デフォルト：`0.1`）
- `-d`, `--debug`: デバッグモード（デフォルト：`False`）

## 出力
- 閾値を超えた先頭からの時間を出力する。
  - ヘッダーは`No.`,`time(s)`, `method`, `duration(s)`, `SNR`, `call_value`
- 全ての見つけた音声をスペクトログラムで出力し色はViridisである。
- スペクトログラムのファイル名は"入力ファイルのボディー"+`_no.png`

## アルゴリズム
- 鳥の声の開始時間を検出する方法について、時間領域と周波数領域の両方のアプローチを説明する。
- ノイズがあるとのことなので、しきい値設定やフィルタリングを適切に調整する必要がある。

### 1. 時間領域で見つける方法（振幅ベース）

- 時間領域では、音声波形の振幅（エネルギー）を解析し、しきい値を超える瞬間を検出する方法がある。

#### 手順
	1.	波形のロード: librosa や scipy.io.wavfile を使って音声データを読み込む。
	2.	短時間エネルギー(STE)の計算:
	  -	一定間隔のウィンドウごとにエネルギー（振幅の2乗の平均）を計算。
	  -	numpy.convolve や librosa.feature.rms でエネルギーを求める。
	3.	しきい値判定:
	  -	エネルギーが一定の閾値を超えた最初の時刻を検出。
	  -	ノイズがある場合は、エネルギーの変動が小さい部分を除外するために平滑化処理（移動平均など）を加える。

#### 特徴:
  -	簡単に実装できる。
	-	鳥の声以外のノイズがある場合は、フィルタリングが必要。

### 2. 周波数領域で見つける方法（スペクトルベース）

- 時間領域ではノイズの影響を受けやすいため、周波数領域で鳥の声の特徴的な周波数帯を検出する方法も有効である。

#### 手順
	1.	STFT（短時間フーリエ変換）を計算:
	  -	librosa.stft() を使用し、時間ごとの周波数成分を求める。
	2.	周波数フィルタリング:
	  -	鳥の声の周波数範囲（例: 2kHz - 10kHz）に絞る。
	  -	librosa.power_to_db() を使い、パワースペクトルをデシベルスケールで分析。
	3.	しきい値判定:
	  -	特定の周波数帯域のエネルギーがしきい値を超えた時間を探す。


#### 特徴:
-	鳥の声の周波数帯域を指定できるので、ノイズ除去がしやすい。
-	一定の周波数に集中したノイズ（例: 風切音、人工音）がある場合は追加のフィルタリングが必要。

#### 比較とまとめ

| 方法 | 長所 | 短所 |
| --- | --- | --- |
| 時間領域（振幅ベース） | 実装が簡単で高速 | ノイズの影響を受けやすい |
| 周波数領域（スペクトルベース） | 鳥の声の特徴的な周波数を利用できる | 計算コストが高め |

#### おすすめの方法
  -	ノイズが少ない場合 → 時間領域（RMSエネルギー）で検出
  -	ノイズが多い場合 → 周波数領域（STFT）で帯域を限定して検出
  -	さらに精度を上げる場合:
    -	両方の方法を組み合わせる（RMSしきい値を超えた時間でSTFTを分析）。
    -	機械学習を導入し、鳥の声とノイズを分類。

- どのような環境で録音された音声か（都市部/森林/風の影響など）によってノイズの特性も異なるので、具体的なデータに応じてフィルタリングを調整すると良いでしょう。