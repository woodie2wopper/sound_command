# FileStamp スクリプト仕様書

## 概要
音声・動画ファイルのタイムスタンプを利用して、666フォーマット（YYMMDD_HHMMSS_HHMMSS）のファイル名を生成するスクリプト。

## 基本情報
- スクリプト名: ICRKikimimi.bash
- 動作環境: bash
- 依存関係: ffprobe（音声・動画ファイルの長さ取得用）

## タイムスタンプ処理
- 使用するタイムスタンプ: ファイルの最終更新時刻（Last Modified Time）
- 取得方法: `date -r`コマンドを使用
- 時刻の扱い：
  - `-S`オプション指定時: 最終更新時刻を録音開始時刻として扱う
  - `-E`オプション指定時: 最終更新時刻を録音終了時刻として扱う（デフォルト）
  - `-R`オプション指定時: 指定された時刻を使用（最終更新時刻は無視）

### タイムスタンプ調整の例
```bash
# === FileStamp.bashを使用する前の時刻調整（touchコマンドによる前処理） ===
# 1年前に変更する場合（例：2024年→2023年）
# 注意：この方法はファイルの最終更新時刻自体を変更します
touch -t $(date -r input.wav '+%Y %m %d %H %M.%S' | awk '{printf "%d%02d%02d%02d%02d.%s\n", $1-1, $2, $3, $4, $5, $6}') input.wav  # $1は年（2024）なので-1で2023年

# 1年後に変更する場合（例：2024年→2025年）
touch -t $(date -r input.wav '+%Y %m %d %H %M.%S' | awk '{printf "%d%02d%02d%02d%02d.%s\n", $1+1, $2, $3, $4, $5, $6}') input.wav  # $1は年（2024）なので+1で2025年

# 特定の日時に変更する場合（例：2023年1月31日12時30分00秒に設定）
touch -t 202301311230.00 input.wav

# touchコマンドによる時刻調整の注意点：
# - ファイルの最終更新時刻自体が変更されます
# - バックアップを取ってから実行することを推奨
# - touchの時刻指定形式：[[CC]YY]MMDDhhmm[.SS]
# - 変更前の時刻を記録しておくことを推奨

# === FileStamp.bashによる時刻調整 ===
# 時刻を9時間進める（日本時間への調整など）
ICRKikimimi.bash -t +090000 input.wav

# 時刻を2時間30分遅らせる
ICRKikimimi.bash -t -023000 input.wav

# 録音開始時刻として扱い、7時間進める
ICRKikimimi.bash -S -t +070000 input.wav

# 録音終了時刻として扱い、1時間45分進める
ICRKikimimi.bash -E -t +014500 input.wav

# 特定の時刻を指定し、さらに8時間進める
ICRKikimimi.bash -R 240131 123000 -t +080000 input.wav

# ICレコーダーの年設定ミスを修正（1年遅らせる場合）
# 例：2024年の録音を2023年に修正
ICRKikimimi.bash -R 230131 123000 input.wav  # 2024/01/31 12:30:00 → 2023/01/31 12:30:00
# または、同じ月日時刻で年だけ変更する場合
ICRKikimimi.bash -R $(date -r input.wav '+%y0%m%d %H%M%S' | awk '{printf "%d%s", substr($1,1,1)-1, substr($1,2)} {print $2}') input.wav

# ICレコーダーの年設定ミスを修正（1年進める場合）
# 例：2024年の録音を2025年に修正
ICRKikimimi.bash -R 250131 123000 input.wav  # 2024/01/31 12:30:00 → 2025/01/31 12:30:00
# または、同じ月日時刻で年だけ変更する場合
ICRKikimimi.bash -R $(date -r input.wav '+%y0%m%d %H%M%S' | awk '{printf "%d%s", substr($1,1,1)+1, substr($1,2)} {print $2}') input.wav
```

注意：時差指定は必ず`±HHMMSS`形式（6桁の数字）で指定する必要があります。
年の調整は`-t`オプションではなく、`-R`オプションを使用して直接時刻を指定します。

## 666フォーマット
- 形式: `YYMMDD_HHMMSS_HHMMSS_ITEM_ORIGINAL.EXT`
  - 最初の6桁: 年月日（YYMMDD）
  - 次の6桁: 録音開始時刻（HHMMSS）
  - 最後の6桁: 録音終了時刻（HHMMSS）
  - ITEM: 録音機器の識別子
  - ORIGINAL: 元のファイル名
  - EXT: ファイルの拡張子

## オプション
| オプション | 引数 | 説明 | デフォルト |
|------------|------|------|------------|
| -S | なし | ファイルスタンプを録音開始時間として扱う | - |
| -E | なし | ファイルスタンプを録音終了時間として扱う | デフォルト |
| -R | [date] [time] | 録音時刻を指定（例: 241031 123345） | なし |
| -I | [item] | 録音機器の指定（DR05, DR05X, LS7, H6, DM750, XACTI等） | none |
| -f | [format] | 出力フォーマット指定（mf: 森下フォーマット） | - |
| -t | [timediff] | 時差指定（±HHMMSS形式） | +000000 |
| -o | [command] | 元ファイル名表示（mv, cp） | mv |
| -d | なし | デバッグモード | - |
| -O | [dir] | 出力ディレクトリ指定 | 入力と同じ |
| -h | なし | ヘルプ表示 | - |

## 対応ファイル形式
- 音声: wav, mp3, aiff, flac
- 動画: mp4, avi

## 森下フォーマット
`-f mf`オプション使用時の出力形式：
- 形式: `[鳥の種類]_[YYYYMMDDHHMMSS]_[場所]_[観察者名].[拡張子]`
- 例: `モズ高鳴き_202109250740_東京都国分寺市_植田睦之.wav`

## 処理フロー
1. オプションとファイルの検証
2. ファイルの長さ（duration）取得
3. タイムスタンプ処理：
   - 開始時刻指定（-S）: timestamp = 開始時刻
   - 終了時刻指定（-E）: timestamp = 終了時刻 - duration
4. 時差調整（-t オプション）
5. ファイル名生成と出力

## 出力
1. 標準フォーマット：
   - `YYMMDD_HHMMSS_HHMMSS_ITEM_ORIGINAL.EXT`
2. 森下フォーマット（-f mf）：
   - `[鳥名]_[YYYYMMDDHHMMSS]_[場所]_[観察者].EXT`

## ログ
- 保存場所: `$HOME/log`
- ファイル名: `ICRKikimimi.bash.YYMMDD_HHMMSS.PID.clog`

## エラーチェック
- 入力ファイルの存在確認
- 対応ファイル形式の検証
- 時差フォーマットの検証（±HHMMSS）
- 出力ディレクトリの存在確認
- 録音時刻指定（-R）の形式検証