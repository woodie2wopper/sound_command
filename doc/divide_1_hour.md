# divide_1_hour.py

長時間録音を１時間毎に分割するスクリプト

## 概要

666形式（YYMMDD_HHMMSS_HHMMSS）の音声ファイルを、１時間毎に分割します。
２つの分割モードがあります：
- 毎時0分0秒に分割（デフォルト）
- 録音開始時刻から1時間毎に分割

オプションで音源をチャンネル毎に分割することもできます。

## ファイル名形式

- 入力ファイル形式: `YYMMDD_HHMMSS_HHMMSS[その他情報].[拡張子]`
  - YYMMDD: 日付（年2桁、月2桁、日2桁）
  - HHMMSS: 時刻（時2桁、分2桁、秒2桁）
  - 最初の時刻: 録音開始時刻
  - 2番目の時刻: 録音終了時刻
  - [その他情報]: オプショナル

- 出力ファイル形式: `YYMMDD_HHMMSS_HHMMSS_dN[その他情報].[拡張子]`
  - YYMMDD: 日付（年2桁、月2桁、日2桁）
  - HHMMSS: 時刻（時2桁、分2桁、秒2桁）
  - 最初の時刻: 分割部分の開始時刻
  - 2番目の時刻: 分割部分の終了時刻
  - dN: 分割番号（d1, d2, ...）
  - [その他情報]: 入力ファイルのその他情報をそのまま引き継ぐ

## コマンドライン引数

```
python divide_1_hour.py [オプション] 入力ファイル
```

入力ファイルはコマンドライン引数のどの位置にでも指定できます。オプションとして認識されない引数（'-'で始まらない引数）が入力ファイルとして処理されます。

## オプション

- `-h, --help`
  - ヘルプメッセージを表示

- `-d, --debug`
  - デバッグモード
  - コマンド実行情報を表示し、実際のファイル分割は行わない

- `-dry, --dry-run`
  - ドライランモード
  - 実際にファイルを生成せず、何が行われるかを表示するだけのモード
  - 処理内容の確認やテストに便利
  - 注意: `-n`ではなく`-dry`を使用（macOSのopenコマンドなどと競合を避けるため）

- `-f, --force`
  - 強制上書きモード
  - 既存のファイルが存在する場合でも強制的に上書きする
  - デフォルトでは既存のファイルはスキップされます

- `-c, --check`
  - 時間検証モード
  - 生成されたファイルの実際の録音時間を666形式の時間情報と比較検証
  - ffprobeを使用してファイルの実際の長さを取得
  - 検証結果はログファイルに記録されます

- `-S, --split-by-hour`
  - 毎時0分0秒に分割する（デフォルト・省略可）
  - 例: 12:34:56に始まるファイルは13:00:00, 14:00:00...で分割
  - このオプションはデフォルトで適用されるため、明示的に指定する必要はありません

- `-t, --split-by-time`
  - 録音開始時刻から1時間毎に分割する
  - 例: 12:34:56に始まるファイルは13:34:56, 14:34:56...で分割

- `-sc, --separate-channel`
  - 音源をチャンネル毎に分割する
  - デフォルトでは多チャンネルの場合もモノラル化されます
  - このオプションを使用するとチャンネル数に応じて複数のファイルが生成されます
  - 出力ファイル名は `元のファイル名-ch-N.拡張子` 形式（Nはチャンネル番号）

## 処理内容

1. 入力ファイル名を解析して、録音開始時刻と終了時刻を抽出
2. 選択されたモードに基づいて分割位置を決定
3. ffmpegを使用して、音声ファイルを分割
4. 分割されたファイルを適切な命名規則で保存

## 使用例

```bash
# デフォルトモード（毎時0分0秒に分割）
python divide_1_hour.py 230101_123456_150000.wav
# 以下も同じ結果になります（-Sは省略可能）
python divide_1_hour.py --split-by-hour 230101_123456_150000.wav

# 引数の順序は自由（入力ファイルが最後でなくても良い）
python divide_1_hour.py 230101_123456_150000.wav -t
python divide_1_hour.py 230101_123456_150000.wav -dry -t

# 録音開始時刻から1時間毎に分割
python divide_1_hour.py -t 230101_123456_150000.wav
python divide_1_hour.py --split-by-time 230101_123456_150000.wav

# デバッグモード（実際の分割は行わず情報表示のみ）
python divide_1_hour.py -d 230101_123456_150000.wav
python divide_1_hour.py --debug 230101_123456_150000.wav

# ドライランモード（ファイル生成せずに何が行われるかを表示）
python divide_1_hour.py -dry 230101_123456_150000.wav
python divide_1_hour.py --dry-run 230101_123456_150000.wav
python divide_1_hour.py -dry --split-by-time 230101_123456_150000.wav

# 既存ファイルを強制的に上書き
python divide_1_hour.py -f 230101_123456_150000.wav
python divide_1_hour.py --force 230101_123456_150000.wav
python divide_1_hour.py -f -t 230101_123456_150000.wav

# チャンネル毎に分割
python divide_1_hour.py -sc 230101_123456_150000.wav
python divide_1_hour.py --separate-channel 230101_123456_150000.wav

# 時間検証モード（生成されたファイルの時間を検証）
python divide_1_hour.py -c 230101_123456_150000.wav
python divide_1_hour.py --check 230101_123456_150000.wav
python divide_1_hour.py -c -sc 230101_123456_150000.wav

# 録音開始時刻から1時間毎に分割し、さらにチャンネル毎に分割
python divide_1_hour.py -t -sc 230101_123456_150000.wav
python divide_1_hour.py --split-by-time --separate-channel 230101_123456_150000.wav
```

## 出力例

入力ファイル: `230101_123456_150000.wav`

デフォルトモード（-S）の場合:
```
分割ファイルを作成しました: 230101_123456_130000_d1.wav
分割ファイルを作成しました: 230101_130000_140000_d2.wav
分割ファイルを作成しました: 230101_140000_150000_d3.wav
```

録音開始時刻からの分割（-t）の場合:
```
分割ファイルを作成しました: 230101_123456_133456_d1.wav
分割ファイルを作成しました: 230101_133456_143456_d2.wav
分割ファイルを作成しました: 230101_143456_150000_d3.wav
```

チャンネル分割（-sc）を使用した場合（2チャンネル音源）:
```
分割ファイルを作成しました: 230101_123456_130000_d1-ch-1.wav
分割ファイルを作成しました: 230101_123456_130000_d1-ch-2.wav
分割ファイルを作成しました: 230101_130000_140000_d2-ch-1.wav
分割ファイルを作成しました: 230101_130000_140000_d2-ch-2.wav
分割ファイルを作成しました: 230101_140000_150000_d3-ch-1.wav
分割ファイルを作成しました: 230101_140000_150000_d3-ch-2.wav
```

## ログ機能

プログラムの実行状況は以下のログファイルに記録されます：

```
/var/data/sound-command/divide_1_hour.log
```

ログディレクトリが存在しない場合は、カレントディレクトリに`divide_1_hour.log`ファイルが作成されます。

ログには以下の情報が記録されます：

- プログラムの開始・終了
- 各オプションの有効化状況
- ファイル処理の結果（作成、スキップ、エラー）
- 時間検証モード（`-c`）を使用した場合の検証結果
- エラー情報

デバッグモード（`-d`）を有効にすると、より詳細なログが記録されます。

## 注意事項

- ffmpegがインストールされている必要があります
- 入力ファイルは666形式である必要があります
- 録音終了時刻が録音開始時刻より前の場合は、翌日として扱われます
- チャンネル分割オプション使用時は、チャンネル数に応じて複数のファイルが生成されます
- デフォルトでは既存のファイルはスキップされます。強制的に上書きするには `-f, --force` オプションを使用してください
- 時間検証モード（`-c`）では、生成されたファイルの実際の時間と666形式から期待される時間の差が1秒以内であれば検証成功とみなされます
